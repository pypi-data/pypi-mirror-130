
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Rules-Based System (RBS) example &#8212; Iguanas  documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/iguanas.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../_static/iguanas_icon.png"/>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Correlation Reduction" href="../correlation_reduction/index.html" />
    <link rel="prev" title="Complete examples" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/iguanas_text_logo.png" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../install/index.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../about_the_project/index.html">
  About the project
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/paypal/Iguanas" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Complete examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Rules-Based System (RBS) example
    </a>
   </li>
  </ul>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../correlation_reduction/index.html">
   Correlation Reduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../correlation_reduction/agglomerative_clustering_reducer_example.html">
     AgglomerativeClusteringReducer Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../metrics/index.html">
   Metrics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../metrics/classification_example.html">
     Classification Metrics Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../metrics/classification_spark_example.html">
     Classification Metrics Spark Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../metrics/pairwise_example.html">
     Pairwise Metrics Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../metrics/unsupervised_example.html">
     Unsupervised Metrics Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../metrics/unsupervised_spark_example.html">
     Unsupervised Metrics Spark Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rbs/index.html">
   Rules-Based System (RBS)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rbs/rbs_pipeline_example.html">
     Rule-Based System (RBS) Pipeline Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rbs/rbs_optimiser_example.html">
     Rule-Based System (RBS) Optimiser Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rule_application/index.html">
   Rule Application
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_application/rule_applier_example.html">
     Rule Applier Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_application/rule_applier_spark_example.html">
     Rule Applier Spark Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rule_generation/index.html">
   Rule Generation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_generation/rule_generator_dt_example.html">
     Rule Generator (Decision Tree algorithm) Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_generation/rule_generator_dt_spark_example.html">
     Rule Generator (Decision Tree algorithm) Spark Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_generation/rule_generator_opt_example.html">
     Rule Generator (Optimisation algorithm) Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rule_optimisation/index.html">
   Rule Optimisation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_optimisation/bayesian_optimiser_example.html">
     Bayesian Optimiser Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_optimisation/bayesian_optimiser_unlabelled_example.html">
     Bayesian Optimiser (unlabelled) Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_optimisation/direct_search_optimiser_example.html">
     Direct Search Optimiser Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_optimisation/direct_search_optimiser_unlabelled_example.html">
     Direct Search Optimiser (unlabelled) Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rule_scoring/index.html">
   Rule Scoring
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_scoring/rule_scorer_example.html">
     Rule Scorer Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rule_selection/index.html">
   Rule Selection
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_selection/simple_filter_example.html">
     SimpleFilter Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_selection/correlated_filter_example.html">
     CorrelatedFilter Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_selection/greedy_filter_example.html">
     GreedyFilter Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rule_selection/grid_search_cv_example.html">
     Grid Search CV Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../rules/index.html">
   Rules
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../rules/rules_example.html">
     Rules Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../rules/convert_processed_conditions_to_general_example.html">
     Convert Processed Conditions to General Example
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Requirements">
   Requirements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Table-of-contents">
   Table of contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Import-packages">
   Import packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Read/process-data">
   Read/process data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Read-in-data">
     Read in data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Process-the-data">
     Process the data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Train/test-split">
       Train/test split
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Process-data-for-rule-generation">
       Process data for rule generation
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#Remove-unnecessary-columns">
         Remove unnecessary columns
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#Impute-null-values">
         Impute null values
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#One-hot-encode-categorical-features">
         One hot encode categorical features
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Rule-generation-(using-GridSearchCV)">
   Rule generation (using GridSearchCV)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Set-up-class-parameters">
     Set up class parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Instantiate-class-and-run-fit-method">
     Instantiate class and run fit method
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Outputs">
     Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Rule-Optimisation-(using-GridSearchCV)">
   Rule Optimisation (using GridSearchCV)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Set up class parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Instantiate class and run fit method
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Combine-rules-and-remove-those-which-are-unnecessary">
   Combine rules and remove those which are unnecessary
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Standard-filter">
     Standard filter
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Outputs
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Remove-correlated-rules">
     Remove correlated rules
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Outputs
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Greedy-filter">
     Greedy filter
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Outputs
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Set-up-the-RBS-Pipeline">
   Set up the RBS Pipeline
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Optimise-the-RBS-Pipeline">
   Optimise the RBS Pipeline
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Filter-rules-for-the-optimised-RBS-Pipeline">
   Filter rules for the optimised RBS Pipeline
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Apply-the-optimised-RBS-Pipeline-to-the-test-set">
   Apply the optimised RBS Pipeline to the test set
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Outputs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Compare-to-initial-RBS-pipeline-performance">
     Compare to initial RBS pipeline performance
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Performance-comparison">
       Performance comparison
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Convert-generated-rule-conditions-to-system-ready">
   Convert generated rule conditions to system-ready
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Our-final-rule-set-and-RBS-Pipeline">
   Our final rule set and RBS Pipeline
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Rules-Based-System-(RBS)-example">
<h1>Rules-Based System (RBS) example<a class="headerlink" href="#Rules-Based-System-(RBS)-example" title="Permalink to this headline">¶</a></h1>
<p>This notebook contains an example of how Iguanas can be used to set up a Rules-Based System (RBS) from scratch. This includes:</p>
<ul class="simple">
<li><p>Generating new rules</p></li>
<li><p>Optimising existing rules</p></li>
<li><p>Combining these rules and removing those which are unnecessary</p></li>
<li><p>Setting up and optimising the RBS pipeline</p></li>
<li><p>Testing the optimised RBS pipeline on a test set</p></li>
</ul>
<p>In this example, we’ll be creating an RBS for a <strong>transaction fraud use case</strong> (i.e. identifying potentially fraudulent transactions). The metric that we’ll optimising for will be the <strong>F1 Score</strong>, and we’ll just be focusing on <strong>rules to capture fraudulent behaviour</strong> (rather than also including rules which capture good behaviour, which is a relevant methodology to use too).</p>
<section id="Requirements">
<h2>Requirements<a class="headerlink" href="#Requirements" title="Permalink to this headline">¶</a></h2>
<p>To run, you’ll need the following:</p>
<ul class="simple">
<li><p>A raw, labelled dataset.</p></li>
</ul>
<hr class="docutils" />
</section>
<section id="Table-of-contents">
<h2>Table of contents<a class="headerlink" href="#Table-of-contents" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="#ReadProcessData">Read/process data</a></p></li>
<li><p><a class="reference external" href="#RuleGeneration">Rule Generation</a></p></li>
<li><p><a class="reference external" href="#RuleOptimisation">Rule Optimisation</a></p></li>
<li><p><a class="reference external" href="#CombineRules">Combine rules and remove those which are unnecessary</a></p></li>
<li><p><a class="reference external" href="#SetUpPipeline">Set up the RBS Pipeline</a></p></li>
<li><p><a class="reference external" href="#OptimiseThePipeline">Optimise the RBS Pipeline</a></p></li>
<li><p><a class="reference external" href="#FilterRulesForPipeline">Filter rules for the optimised RBS Pipeline</a></p></li>
<li><p><a class="reference external" href="#ApplyPipeline">Apply the optimised RBS Pipeline to the test set</a></p></li>
<li><p><a class="reference external" href="#FinalRuleSet">Our final rule set and RBS Pipeline</a></p></li>
</ol>
<hr class="docutils" />
</section>
<section id="Import-packages">
<h2>Import packages<a class="headerlink" href="#Import-packages" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">iguanas.rule_generation</span> <span class="kn">import</span> <span class="n">RuleGeneratorDT</span>
<span class="kn">from</span> <span class="nn">iguanas.rule_optimisation</span> <span class="kn">import</span> <span class="n">BayesianOptimiser</span>
<span class="kn">from</span> <span class="nn">iguanas.metrics.classification</span> <span class="kn">import</span> <span class="n">FScore</span>
<span class="kn">from</span> <span class="nn">iguanas.metrics.pairwise</span> <span class="kn">import</span> <span class="n">JaccardSimilarity</span>
<span class="kn">from</span> <span class="nn">iguanas.rules</span> <span class="kn">import</span> <span class="n">Rules</span><span class="p">,</span> <span class="n">ConvertProcessedConditionsToGeneral</span><span class="p">,</span> <span class="n">ReturnMappings</span>
<span class="kn">from</span> <span class="nn">iguanas.correlation_reduction</span> <span class="kn">import</span> <span class="n">AgglomerativeClusteringReducer</span>
<span class="kn">from</span> <span class="nn">iguanas.rule_selection</span> <span class="kn">import</span> <span class="n">SimpleFilter</span><span class="p">,</span> <span class="n">GreedyFilter</span><span class="p">,</span> <span class="n">CorrelatedFilter</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">iguanas.rbs</span> <span class="kn">import</span> <span class="n">RBSPipeline</span><span class="p">,</span> <span class="n">RBSOptimiser</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">category_encoders.one_hot</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">hyperopt</span> <span class="kn">import</span> <span class="n">tpe</span><span class="p">,</span> <span class="n">anneal</span>
<span class="kn">import</span> <span class="nn">pickle</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="Read/process-data">
<h2>Read/process data<a class="headerlink" href="#Read/process-data" title="Permalink to this headline">¶</a></h2>
<section id="Read-in-data">
<h3>Read in data<a class="headerlink" href="#Read-in-data" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;dummy_data/dummy_pipeline_output_data.csv&#39;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;eid&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(13276, 64)
</pre></div></div>
</div>
<p>Then we can split the data into features (<em>X</em>) and the target column (<em>y</em>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fraud_column</span> <span class="o">=</span> <span class="s1">&#39;sim_is_fraud&#39;</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">fraud_column</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">fraud_column</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Process-the-data">
<h3>Process the data<a class="headerlink" href="#Process-the-data" title="Permalink to this headline">¶</a></h3>
<section id="Train/test-split">
<h4>Train/test split<a class="headerlink" href="#Train/test-split" title="Permalink to this headline">¶</a></h4>
<p>Before applying any data processing steps, we should split the data into training and test sets:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Process-data-for-rule-generation">
<h4>Process data for rule generation<a class="headerlink" href="#Process-data-for-rule-generation" title="Permalink to this headline">¶</a></h4>
<p>When generating new rules, we need to first process the data. The main data processesing steps that need to be applied before using the rule generator are:</p>
<ul class="simple">
<li><p>Remove uneccessary columns</p></li>
<li><p>Impute null values</p></li>
<li><p>One hot encode categorical features</p></li>
<li><p>Feature selection <strong>(in this case, the feature set is small, so this step is omitted from the example)</strong></p></li>
</ul>
<section id="Remove-unnecessary-columns">
<h5>Remove unnecessary columns<a class="headerlink" href="#Remove-unnecessary-columns" title="Permalink to this headline">¶</a></h5>
<p>We need to remove those columns which will not be useful or make sense to have in our rules - in this case, this includes any features whose name containis ‘sim’, ‘eid’ or any high cardinality columns. Note however that there may be additional columns that you have to remove from your dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sim_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;sim_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">eid_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;eid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">high_card_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">[(</span><span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">sim_cols</span> <span class="o">+</span> <span class="n">eid_cols</span> <span class="o">+</span> <span class="n">high_card_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">sim_cols</span> <span class="o">+</span> <span class="n">eid_cols</span> <span class="o">+</span> <span class="n">high_card_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 27), (4382, 27))
</pre></div></div>
</div>
</section>
<section id="Impute-null-values">
<h5>Impute null values<a class="headerlink" href="#Impute-null-values" title="Permalink to this headline">¶</a></h5>
<p>We can now impute the null values. You can use any imputation method you like - here we’ll impute using the following methodology:</p>
<ul class="simple">
<li><p>Impute numeric values with -1.</p></li>
<li><p>Impute categorical features with the category ‘missing’.</p></li>
<li><p>Impute boolean features with ‘missing’.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[112]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of null values in X_train:&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of null values in X_train: 4766
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[113]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cat_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">bool_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span><span class="p">[</span><span class="n">bool_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">bool_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">bool_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">bool_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">num_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">num_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cat_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;missing&#39;</span><span class="p">)</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">bool_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">bool_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;missing&#39;</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">num_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">num_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cat_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;missing&#39;</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">bool_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">bool_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;missing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of null values in X_train:&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of null values in X_train: 0
</pre></div></div>
</div>
</section>
<section id="One-hot-encode-categorical-features">
<h5>One hot encode categorical features<a class="headerlink" href="#One-hot-encode-categorical-features" title="Permalink to this headline">¶</a></h5>
<p>Now we can one hot encode the categorical features:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">use_cat_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[118]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ohe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jlaidler/venvs/iguanas_os_dev/lib/python3.8/site-packages/category_encoders/utils.py:21: FutureWarning: is_categorical is deprecated and will be removed in a future version.  Use is_categorical_dtype instead
  elif pd.api.types.is_categorical(cols):
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[119]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[119]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 29), (4382, 29))
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
</section>
</section>
<section id="Rule-generation-(using-GridSearchCV)">
<h2>Rule generation (using GridSearchCV)<a class="headerlink" href="#Rule-generation-(using-GridSearchCV)" title="Permalink to this headline">¶</a></h2>
<p>Now that we’ve processed our raw data, we can use this to generate rules. There are two rule generator algorithms in Iguanas:</p>
<ul class="simple">
<li><p><strong>RuleGeneratorDT</strong>: Generate rules by extracting the highest performing branches from a tree ensemble model.</p></li>
<li><p><strong>RuleGeneratorOpt</strong>: Generate rules by optimising the thresholds of single features and combining these one condition rules with AND conditions to create more complex rules.</p></li>
</ul>
<p>We can also use the <em>GridSearchCV</em> class to implement stratifield k-fold cross validation when searching for the best rule generation parameters. <strong>This allows us to find the best rule generation parameters whilst also reducing the likelihood of overfitting.</strong></p>
<p><strong>In this example, we’ll only use the RuleGeneratorDT, but you can use the RuleGeneratorOpt instead or additionally.</strong></p>
<section id="Set-up-class-parameters">
<h3>Set up class parameters<a class="headerlink" href="#Set-up-class-parameters" title="Permalink to this headline">¶</a></h3>
<p>We first need to define the search values for each parameter in the provided rule generation class. We define these in a dictionary, where the dictionary keys are the relevant rule generation parameters and the dictionary values are lists of search values for each parameter. The <em>GridSearchCV</em> class will then calculate each unique combination of parameter values, and find the set of parameters that produce the best mean overall rule performance across the folds.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[120]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f1</span> <span class="o">=</span> <span class="n">FScore</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[121]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;opt_func&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">f1</span><span class="o">.</span><span class="n">fit</span><span class="p">],</span>
    <span class="s1">&#39;n_total_conditions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;tree_ensemble&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="s1">&#39;target_feat_corr_types&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Infer&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now that we have our search values, we can define the rest of the <em>GridSearchCV</em> class parameters. <strong>Note here that we are splitting the data into 3 folds for training/validation.</strong></p>
<p><strong>Please see the class docstring for more information on each parameter</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[122]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rule_class&#39;</span><span class="p">:</span> <span class="n">RuleGeneratorDT</span><span class="p">,</span>
    <span class="s1">&#39;param_grid&#39;</span><span class="p">:</span> <span class="n">param_grid</span><span class="p">,</span>
    <span class="s1">&#39;greedy_filter_opt_func&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
    <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;num_cores&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Instantiate-class-and-run-fit-method">
<h3>Instantiate class and run fit method<a class="headerlink" href="#Instantiate-class-and-run-fit-method" title="Permalink to this headline">¶</a></h3>
<p>Once the parameters have been set, we can run the <em>.fit()</em> method to search for the best rule generation parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[123]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6 unique parameter sets
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[124]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Fitting and validating rules using folds ---
100%|██████████| 18/18 [00:00&lt;00:00, 20.02it/s]
--- Re-fitting rules using best parameters on full dataset ---
--- Filtering rules to give best combined performance ---
</pre></div></div>
</div>
</section>
<section id="Outputs">
<h3>Outputs<a class="headerlink" href="#Outputs" title="Permalink to this headline">¶</a></h3>
<p>The <em>.fit()</em> method does not return any objects. However, it does generate the following useful attributes:</p>
<ul class="simple">
<li><p>rule_strings (Dict[str, str]): The rules which achieved the best combined performance, defined using the standard Iguanas string format (values) and their names (keys).</p></li>
<li><p>param_results_per_fold (pd.DataFrame): Shows the best combined rule performance observed for each parameter set and fold.</p></li>
<li><p>param_results_aggregated (pd.DataFrame): Shows the mean and the standard deviation of the best combined rule performance, calculated across the folds, for each parameter set.</p></li>
<li><p>best_perf (float): The best combined rule performance achieved.</p></li>
<li><p>best_params (dict): The parameter set that achieved the best combined rule performance.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[125]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">param_results_per_fold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[125]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>opt_func</th>
      <th>n_total_conditions</th>
      <th>tree_ensemble</th>
      <th>target_feat_corr_types</th>
      <th>Performance</th>
    </tr>
    <tr>
      <th>Fold</th>
      <th>ParamSetIndex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">0</th>
      <th>0</th>
      <td>&lt;bound method FScore.fit of FScore with beta=1&gt;</td>
      <td>3</td>
      <td>(DecisionTreeClassifier(max_depth=3, max_featu...</td>
      <td>Infer</td>
      <td>0.993939</td>
    </tr>
    <tr>
      <th>1</th>
      <td>&lt;bound method FScore.fit of FScore with beta=1&gt;</td>
      <td>3</td>
      <td>RandomForestClassifier(n_estimators=30, random...</td>
      <td>Infer</td>
      <td>0.993939</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[126]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">param_results_aggregated</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[126]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>opt_func</th>
      <th>n_total_conditions</th>
      <th>tree_ensemble</th>
      <th>target_feat_corr_types</th>
      <th>PerformancePerFold</th>
      <th>MeanPerformance</th>
      <th>StdDevPerformance</th>
    </tr>
    <tr>
      <th>ParamSetIndex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>&lt;bound method FScore.fit of FScore with beta=1&gt;</td>
      <td>3</td>
      <td>(DecisionTreeClassifier(max_depth=3, max_featu...</td>
      <td>Infer</td>
      <td>[0.993939393939394, 1.0, 0.9938650306748467]</td>
      <td>0.995935</td>
      <td>0.002875</td>
    </tr>
    <tr>
      <th>1</th>
      <td>&lt;bound method FScore.fit of FScore with beta=1&gt;</td>
      <td>3</td>
      <td>RandomForestClassifier(n_estimators=30, random...</td>
      <td>Infer</td>
      <td>[0.993939393939394, 1.0, 0.9938650306748467]</td>
      <td>0.995935</td>
      <td>0.002875</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">best_perf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9959348082047469
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[128]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">best_params</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[128]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;opt_func&#39;: &lt;bound method FScore.fit of FScore with beta=1&gt;,
 &#39;n_total_conditions&#39;: 3,
 &#39;tree_ensemble&#39;: RandomForestClassifier(max_depth=3, n_estimators=15, random_state=0),
 &#39;target_feat_corr_types&#39;: &#39;Infer&#39;}
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="Rule-Optimisation-(using-GridSearchCV)">
<h2>Rule Optimisation (using GridSearchCV)<a class="headerlink" href="#Rule-Optimisation-(using-GridSearchCV)" title="Permalink to this headline">¶</a></h2>
<p>Now we can optimise the existing rules.</p>
<p>First, we’ll read in the existing rules, which have been stored in the standard Iguanas string format:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dummy_data/rule_strings.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">rule_strings</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can then instantiate the <em>Rules</em> class with these rules, so that we can convert them into the standard Iguanas lambda expression format:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">existing_rules</span> <span class="o">=</span> <span class="n">Rules</span><span class="p">(</span><span class="n">rule_strings</span><span class="o">=</span><span class="n">rule_strings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To convert the rules, we use the <em>as_rule_lambdas()</em> method from the instantiated <em>Rules</em> class:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[131]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">existing_rule_lambdas</span> <span class="o">=</span> <span class="n">existing_rules</span><span class="o">.</span><span class="n">as_rule_lambdas</span><span class="p">(</span><span class="n">as_numpy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The standard Iguanas lambda expression format allows new values to be injected into the condition string of a rule. This means that the rule’s performance can be evaluated with new values (this capability is leveraged in the rule optimisers).</p>
<p>We can now use the <em>GridSearchCV</em> class to implement stratifield k-fold cross validation to search for the best rule optimisation parameters. <strong>This allows us to find the best rule optimisation parameters whilst also reducing the likelihood of overfitting.</strong></p>
<section id="id1">
<h3>Set up class parameters<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>We firstly need to define the search values for each parameter in the provided rule optimisation class. We define these in a dictionary, where the dictionary keys are the relevant rule optimisation parameters and the dictionary values are lists of search values for each parameter. The <em>GridSearchCV</em> class will then calculate each unique combination of parameter values, and find the set of parameters that produce the best mean overall rule performance across the folds.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f0dot5</span> <span class="o">=</span> <span class="n">FScore</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">FScore</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[133]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rule_lambdas&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">existing_rule_lambdas</span><span class="p">],</span>
    <span class="s1">&#39;lambda_kwargs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">existing_rules</span><span class="o">.</span><span class="n">lambda_kwargs</span><span class="p">],</span>
    <span class="s1">&#39;opt_func&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">f0dot5</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span> <span class="n">f1</span><span class="o">.</span><span class="n">fit</span><span class="p">],</span>
    <span class="s1">&#39;n_iter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">],</span>
    <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span> <span class="n">anneal</span><span class="o">.</span><span class="n">suggest</span><span class="p">],</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now that we have our search values, we can define the rest of the <em>GridSearchCV</em> class parameters. <strong>Note here that we are splitting the data into 3 folds for training/validation.</strong></p>
<p><strong>Please see the class docstring for more information on each parameter</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rule_class&#39;</span><span class="p">:</span> <span class="n">BayesianOptimiser</span><span class="p">,</span>
    <span class="s1">&#39;param_grid&#39;</span><span class="p">:</span> <span class="n">param_grid</span><span class="p">,</span>
    <span class="s1">&#39;greedy_filter_opt_func&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
    <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;num_cores&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="id2">
<h3>Instantiate class and run fit method<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Once the parameters have been set, we can run the <em>.fit()</em> method to search for the best rule optimisation parameters. <strong>Note that we use the raw, unprocessed data here, as productionised rules will usually run on raw data:</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_opt</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
4 unique parameter sets
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_opt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Fitting and validating rules using folds ---
  0%|          | 0/12 [00:00&lt;?, ?it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 67%|██████▋   | 8/12 [00:02&lt;00:01,  3.87it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
100%|██████████| 12/12 [00:03&lt;00:00,  3.04it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Re-fitting rules using best parameters on full dataset ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jlaidler/Documents/argo/iguanas/rule_optimisation/_base_optimiser.py:189: UserWarning: Rules `Rule2`, `Rule3` have no optimisable conditions - unable to optimise these rules
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Filtering rules to give best combined performance ---
</pre></div></div>
</div>
</section>
<section id="id3">
<h3>Outputs<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The <em>.fit()</em> method does not return any objects. However, it does generate the following useful attributes:</p>
<ul class="simple">
<li><p>rule_strings (Dict[str, str]): The rules which achieved the best combined performance, defined using the standard Iguanas string format (values) and their names (keys).</p></li>
<li><p>param_results_per_fold (pd.DataFrame): Shows the best combined rule performance observed for each parameter set and fold.</p></li>
<li><p>param_results_aggregated (pd.DataFrame): Shows the mean and the standard deviation of the best combined rule performance, calculated across the folds, for each parameter set.</p></li>
<li><p>best_perf (float): The best combined rule performance achieved.</p></li>
<li><p>best_params (dict): The parameter set that achieved the best combined rule performance.</p></li>
</ul>
<p><strong>Note the following cases where the rule optimiser will be unable to run:</strong></p>
<ul class="simple">
<li><p>Rules that contain features that are missing in <code class="docutils literal notranslate"><span class="pre">X</span></code>.</p></li>
<li><p>Rules that contain no optimisable features (e.g. all of the conditions are string-based).</p></li>
<li><p>Rules that contain exclusively zero variance features.</p></li>
<li><p>Rules that contain a feature that is completely null in <code class="docutils literal notranslate"><span class="pre">X</span></code>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[137]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_opt</span><span class="o">.</span><span class="n">param_results_per_fold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[137]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>rule_lambdas</th>
      <th>lambda_kwargs</th>
      <th>opt_func</th>
      <th>n_iter</th>
      <th>algorithm</th>
      <th>verbose</th>
      <th>Performance</th>
    </tr>
    <tr>
      <th>Fold</th>
      <th>ParamSetIndex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">0</th>
      <th>0</th>
      <td>{'RGDT_Rule137': &lt;function ConvertRuleDictsToR...</td>
      <td>{'RGDT_Rule137': {'account_number_avg_order_to...</td>
      <td>&lt;bound method FScore.fit of FScore with beta=0.5&gt;</td>
      <td>30</td>
      <td>&lt;function suggest at 0x7fc179a0bd30&gt;</td>
      <td>0</td>
      <td>0.993939</td>
    </tr>
    <tr>
      <th>1</th>
      <td>{'RGDT_Rule137': &lt;function ConvertRuleDictsToR...</td>
      <td>{'RGDT_Rule137': {'account_number_avg_order_to...</td>
      <td>&lt;bound method FScore.fit of FScore with beta=0.5&gt;</td>
      <td>30</td>
      <td>&lt;function suggest at 0x7fc1b0a8c550&gt;</td>
      <td>0</td>
      <td>0.993939</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_opt</span><span class="o">.</span><span class="n">param_results_aggregated</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rule_lambdas</th>
      <th>lambda_kwargs</th>
      <th>opt_func</th>
      <th>n_iter</th>
      <th>algorithm</th>
      <th>verbose</th>
      <th>PerformancePerFold</th>
      <th>MeanPerformance</th>
      <th>StdDevPerformance</th>
    </tr>
    <tr>
      <th>ParamSetIndex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>{'RGDT_Rule137': &lt;function ConvertRuleDictsToR...</td>
      <td>{'RGDT_Rule137': {'account_number_avg_order_to...</td>
      <td>&lt;bound method FScore.fit of FScore with beta=0.5&gt;</td>
      <td>30</td>
      <td>&lt;function suggest at 0x7fc179a0bd30&gt;</td>
      <td>0</td>
      <td>[0.993939393939394, 1.0, 0.9938650306748467]</td>
      <td>0.995935</td>
      <td>0.002875</td>
    </tr>
    <tr>
      <th>1</th>
      <td>{'RGDT_Rule137': &lt;function ConvertRuleDictsToR...</td>
      <td>{'RGDT_Rule137': {'account_number_avg_order_to...</td>
      <td>&lt;bound method FScore.fit of FScore with beta=0.5&gt;</td>
      <td>30</td>
      <td>&lt;function suggest at 0x7fc1b0a8c550&gt;</td>
      <td>0</td>
      <td>[0.993939393939394, 1.0, 0.9938650306748467]</td>
      <td>0.995935</td>
      <td>0.002875</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[139]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_opt</span><span class="o">.</span><span class="n">best_perf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[139]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9959348082047469
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="Combine-rules-and-remove-those-which-are-unnecessary">
<h2>Combine rules and remove those which are unnecessary<a class="headerlink" href="#Combine-rules-and-remove-those-which-are-unnecessary" title="Permalink to this headline">¶</a></h2>
<p>We now have two sets of rules:</p>
<ol class="arabic simple">
<li><p>Newly generated rules</p></li>
<li><p>Optimised existing rules</p></li>
</ol>
<p>We can combine these rule sets, then apply correlation reduction and filtering methods to remove those which are unneccesary.</p>
<p>To do this, we need to calculate the binary columns and the performance dataframes of each rule set. This can be done using the <em>apply</em> method from each of the instantiated <em>GridSearchCV</em> classes (one for our generated rules; one for our optimised rules):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[140]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Generated rules</span>
<span class="n">X_rules_gen_train</span> <span class="o">=</span> <span class="n">gs_gen</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
<span class="c1"># Optimised rules (note we use the raw, unprocessed data here)</span>
<span class="n">X_rules_opt_train</span> <span class="o">=</span> <span class="n">gs_opt</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can combine the binary columns and performance dataframes of each rule set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[141]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">X_rules_gen_train</span><span class="p">,</span>
    <span class="n">X_rules_opt_train</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">rule_descriptions_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">gs_gen</span><span class="o">.</span><span class="n">rule_descriptions</span><span class="p">,</span>
    <span class="n">gs_opt</span><span class="o">.</span><span class="n">rule_descriptions</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[142]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[142]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Rule</th>
      <th>RGDT_Rule_20211202_27</th>
      <th>RGDT_Rule_20211202_24</th>
      <th>RGDT_Rule_20211202_22</th>
      <th>RGDT_Rule_20211202_25</th>
      <th>RGDT_Rule_20211202_16</th>
      <th>RGDT_Rule_20211202_17</th>
      <th>RGDT_Rule_20211202_31</th>
      <th>HighFraudTxnPerAccountNum</th>
      <th>RGDT_Rule256</th>
      <th>RGDT_Rule193</th>
      <th>RGDT_Rule45</th>
      <th>RGDT_Rule241</th>
      <th>RGDT_Rule313</th>
    </tr>
    <tr>
      <th>eid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>503-0182982-0226911</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>516-2441570-6696110</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[143]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rule_descriptions_train</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[143]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Precision</th>
      <th>Recall</th>
      <th>PercDataFlagged</th>
      <th>OptMetric</th>
      <th>Logic</th>
      <th>nConditions</th>
    </tr>
    <tr>
      <th>Rule</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RGDT_Rule_20211202_27</th>
      <td>0.991903</td>
      <td>1.000000</td>
      <td>0.027772</td>
      <td>0.995935</td>
      <td>(X['account_number_num_fraud_transactions_per_...</td>
      <td>2</td>
    </tr>
    <tr>
      <th>RGDT_Rule_20211202_24</th>
      <td>1.000000</td>
      <td>0.730612</td>
      <td>0.020126</td>
      <td>0.844340</td>
      <td>(X['account_number_num_fraud_transactions_per_...</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[144]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rule_descriptions_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[144]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 13), (13, 6))
</pre></div></div>
</div>
<section id="Standard-filter">
<h3>Standard filter<a class="headerlink" href="#Standard-filter" title="Permalink to this headline">¶</a></h3>
<p>We can use the <em>SimpleFilter</em> class from the <em>rule_selection</em> module to filter out rules whose performance is below a desired threshold. In this example, we’ll filter out rules with an F1 score below 0.01. Let’s first set up our filters - <strong>note that we use the key ‘OptMetric’ for the F1 score (since this is the metric that we used to generate and optimise the rules):</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[145]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;OptMetric&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Operator&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="mf">0.01</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now we can instantiate the <em>SimpleFilter</em> class and run the <em>fit_transform()</em> method to remove the rules which do not meet the filter requirements:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[146]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fr</span> <span class="o">=</span> <span class="n">SimpleFilter</span><span class="p">(</span>
    <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
    <span class="n">rule_descriptions</span><span class="o">=</span><span class="n">rule_descriptions_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[147]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
    <span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_train</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="id4">
<h4>Outputs<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The <em>.fit_transform()</em> method returns a dataframe containing the filtered rule binary columns. It also creates the following useful attributes:</p>
<ul class="simple">
<li><p>rules_to_keep (list): List of rules which remain after the filters have been applied.</p></li>
<li><p>rule_descriptions (pd.DataFrame): The standard performance metrics dataframe associated with the filtered rules.</p></li>
</ul>
<p>We can assign the <em>rule_descriptions</em> dataframe from the class to our variable, ensuring that the filtered rules are removed from the dataframe:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[148]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rule_descriptions_train</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">rule_descriptions</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[149]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rule_descriptions_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[149]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 11), (11, 6))
</pre></div></div>
</div>
</section>
</section>
<section id="Remove-correlated-rules">
<h3>Remove correlated rules<a class="headerlink" href="#Remove-correlated-rules" title="Permalink to this headline">¶</a></h3>
<p>We can use the <em>CorrelatedFilter</em> class from the <em>rule_selection</em> module along with a correlation reduction class to remove correlated rules - see the <em>correlation_reduction_methods</em> module for more information on these classes.</p>
<p>In this example, we’ll be using the <em>AgglomerativeClusteringReducer</em> class from that module. To instantiate this class, we also need to define a similarity function - see the <em>similarity_functions</em> module for more information. In this example, we’ll use the Jaccard similarity:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[150]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">js</span> <span class="o">=</span> <span class="n">JaccardSimilarity</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[151]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">acfr</span> <span class="o">=</span> <span class="n">AgglomerativeClusteringReducer</span><span class="p">(</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;bottom_up&#39;</span><span class="p">,</span>
    <span class="n">similarity_function</span><span class="o">=</span><span class="n">js</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
    <span class="n">columns_performance</span><span class="o">=</span><span class="n">rule_descriptions_train</span><span class="p">[</span><span class="s1">&#39;OptMetric&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can instantiate the <em>CorrelatedFilter</em> class, and run the <em>fit_transform()</em> method to remove correlated rules:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[152]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fcr</span> <span class="o">=</span> <span class="n">CorrelatedFilter</span><span class="p">(</span>
    <span class="n">correlation_reduction_class</span><span class="o">=</span><span class="n">acfr</span><span class="p">,</span>
    <span class="n">rule_descriptions</span><span class="o">=</span><span class="n">rule_descriptions_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[153]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="id5">
<h4>Outputs<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>The <em>.fit_transform()</em> method returns a dataframe containing the binary columns of the uncorrelated rules. It also creates the following useful attributes:</p>
<ul class="simple">
<li><p>rules_to_keep (list): List of rules which remain after the correlation reduction has been applied.</p></li>
<li><p>rule_descriptions (pd.DataFrame): The standard performance metrics dataframe associated with the uncorrelated rules.</p></li>
</ul>
<p>We can assign the <em>rule_descriptions</em> dataframe from the class to our variable, ensuring that the correlated rules are removed from the dataframe:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[154]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rule_descriptions_train</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">rule_descriptions</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[155]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rule_descriptions_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[155]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 9), (9, 6))
</pre></div></div>
</div>
</section>
</section>
<section id="Greedy-filter">
<h3>Greedy filter<a class="headerlink" href="#Greedy-filter" title="Permalink to this headline">¶</a></h3>
<p>We can use the <em>GreedyFilter</em> class from the <em>rule_selection</em> module to sort the rules by a given metric (e.g. precision), then iterate through the rules and calculate the combined performance of the top n number of rules. Here, we’ll sort the rules by precision, then calculate the F1 score of the top n combined rules:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[156]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gf</span> <span class="o">=</span> <span class="n">GreedyFilter</span><span class="p">(</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">f1</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
    <span class="n">rule_descriptions</span><span class="o">=</span><span class="n">rule_descriptions_train</span><span class="p">,</span>
    <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[157]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
    <span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_train</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Calculating performance of top n rules ---
100%|██████████| 9/9 [00:00&lt;00:00, 738.43it/s]
</pre></div></div>
</div>
<p>We can also plot the combined performance of the top <em>n</em> rules (calculated from running the <em>.fit()</em> method) on the training set using the <em>.plot_top_n_performance_on_train()</em> method:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[158]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gf</span><span class="o">.</span><span class="n">plot_top_n_performance_on_train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_complete_rbs_example_118_0.svg" src="../../_images/examples_complete_rbs_example_118_0.svg" /></div>
</div>
<p>The graph shows that when the rules are sorted by precision, then the F1 score is calculated for the top n combined rules, the combined performance begins to plateau/drop. So the algorithm will only keep those rules that deliver the maximum combined performance (and drop the rest).</p>
<section id="id6">
<h4>Outputs<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>The <em>.fit_transform()</em> method returns a dataframe containing the filtered rule binary columns. It also creates the following useful attributes:</p>
<ul class="simple">
<li><p>rules_to_keep (list): List of rules which remain after the filters have been applied.</p></li>
<li><p>rule_descriptions (pd.DataFrame): The standard performance metrics dataframe associated with the filtered rules.</p></li>
</ul>
<p>We can assign the <em>rule_descriptions</em> dataframe from the class to our variable, ensuring that the filtered rules are removed from the dataframe:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[159]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rule_descriptions_train</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">rule_descriptions</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[160]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rule_descriptions_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[160]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((8894, 8), (8, 6))
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
</section>
<section id="Set-up-the-RBS-Pipeline">
<h2>Set up the RBS Pipeline<a class="headerlink" href="#Set-up-the-RBS-Pipeline" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s set up our RBS Pipeline using our combined, filtered rule set. In this case, we’ll go for a simple approach:</p>
<ol class="arabic simple">
<li><p>If any rules trigger, reject the transaction.</p></li>
<li><p>If no rules trigger, approve any remaining transactions.</p></li>
</ol>
<p>To set up the pipeline using the logic above, we first need to create the <em>config</em> - this is just a list which outlines the stages of the pipeline. Each stage should be defined using a single-element dictionary, where the key corresponds to the decision at that stage (either <em>0</em> or <em>1</em>), and the value is a list that dictates which rules should trigger for that decision to be made.</p>
<p>In our example, the config will be:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[161]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">X_rules_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Here, the first stage is configured via the dictionary in the first element of the list. This says to apply a decision of <em>1</em> (i.e. reject) to transactions where the any of the rules have triggered.</p>
<p>We also need to specify the final decision to be made if no rules are triggered - this is set via the <em>final_decision</em> parameter. In our case this should be <em>0</em>, as we want to approve any remaining transactions:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[162]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">final_decision</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<p>With these parameters configured, we can now instantiate our <em>RBSPipeline</em> class:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[163]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbsp</span> <span class="o">=</span> <span class="n">RBSPipeline</span><span class="p">(</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">final_decision</span><span class="o">=</span><span class="n">final_decision</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">f1</span><span class="o">.</span><span class="n">fit</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="Optimise-the-RBS-Pipeline">
<h2>Optimise the RBS Pipeline<a class="headerlink" href="#Optimise-the-RBS-Pipeline" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our RBS Pipeline set up, we can optimise it using the RBS Optimiser. Here, we just pass the instatiated pipeline class to the <em>pipeline</em> parameter:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[164]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span> <span class="o">=</span> <span class="n">RBSOptimiser</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="o">=</span><span class="n">rbsp</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we run the <em>.fit_transform()</em> method to optimise the pipeline using the given dataset, then apply it to the dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[165]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pipe_pred_train</span> <span class="o">=</span> <span class="n">rbso</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span>
    <span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_train</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
100%|██████████| 60/60 [00:00&lt;00:00, 83.16trial/s, best loss: -0.9959349593495934]
</pre></div></div>
</div>
<section id="id7">
<h3>Outputs<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>The <em>.fit_transform()</em> method optimises the pipeline and returns the prediction of the optimised pipeline by applying it to the given dataset.</p>
<p>Useful attributes created by running the <em>.fit_transform()</em> method are:</p>
<ul class="simple">
<li><p>config (List[str]): The optimised pipeline configuration, where each element aligns to a stage in the pipeline. Each element is a dictionary, where the key is the decision made at that stage (either 0 or 1) and the value is a list of the rules that must trigger to give that decision.</p></li>
<li><p>pipeline_opt_metric (float): The result of the <code class="docutils literal notranslate"><span class="pre">opt_func</span></code> function when the pipeline is applied.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[166]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">config</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[166]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{1: [&#39;RGDT_Rule_20211202_25&#39;,
   &#39;RGDT_Rule_20211202_24&#39;,
   &#39;RGDT_Rule193&#39;,
   &#39;RGDT_Rule241&#39;,
   &#39;RGDT_Rule_20211202_27&#39;]}]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[167]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_opt_metric</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[167]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9959349593495934
</pre></div></div>
</div>
<p>We can also use the <em>.calc_performance()</em> method to generate some performance metrics for the pipeline:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[168]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">calc_performance</span><span class="p">(</span>
    <span class="n">y_true</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">y_pred</span><span class="o">=</span><span class="n">pipe_pred_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[169]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_perf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[169]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Precision</th>
      <th>Recall</th>
      <th>PercDataFlagged</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.991903</td>
      <td>1.000000</td>
      <td>0.027772</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1.000000</td>
      <td>0.999769</td>
      <td>0.972228</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[170]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">conf_matrix</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[170]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>245.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>8647.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="Filter-rules-for-the-optimised-RBS-Pipeline">
<h2>Filter rules for the optimised RBS Pipeline<a class="headerlink" href="#Filter-rules-for-the-optimised-RBS-Pipeline" title="Permalink to this headline">¶</a></h2>
<p>Now that we know which rules we need for our final, optimised RBS Pipeline, we can filter our original generated and optimised rule sets to include only those rules which are required.</p>
<p>First, we get the rule names from the optimised RBS Pipeline config:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[171]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbs_rule_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">rule</span> <span class="k">for</span> <span class="n">stage_dict</span> <span class="ow">in</span> <span class="n">rbso</span><span class="o">.</span><span class="n">config</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stage_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<p>Then we split them into rules that were generated and rules that were optimised:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[172]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbs_rule_names_gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">rule</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rbs_rule_names</span> <span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">gs_gen</span><span class="o">.</span><span class="n">rule_strings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="n">rbs_rule_names_opt</span> <span class="o">=</span> <span class="p">[</span><span class="n">rule</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rbs_rule_names</span> <span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">gs_opt</span><span class="o">.</span><span class="n">rule_strings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<p>Finally, we filter the original generated and optimised rule sets:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[173]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gs_gen</span><span class="o">.</span><span class="n">filter_rules</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">rbs_rule_names_gen</span><span class="p">)</span>
<span class="n">gs_opt</span><span class="o">.</span><span class="n">filter_rules</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">rbs_rule_names_opt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="Apply-the-optimised-RBS-Pipeline-to-the-test-set">
<h2>Apply the optimised RBS Pipeline to the test set<a class="headerlink" href="#Apply-the-optimised-RBS-Pipeline-to-the-test-set" title="Permalink to this headline">¶</a></h2>
<p>To apply our optimised RBS Pipeline to the test set, we first need to apply our filtered generated and optimised rules to the test set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[174]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Generated rules</span>
<span class="n">X_rules_gen_test</span> <span class="o">=</span> <span class="n">gs_gen</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_test</span>
<span class="p">)</span>
<span class="c1"># Optimised rules (note we using the raw, unprocessed data here)</span>
<span class="n">X_rules_opt_test</span> <span class="o">=</span> <span class="n">gs_opt</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can combine these binary columns into one set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[175]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">X_rules_gen_test</span><span class="p">,</span>
    <span class="n">X_rules_opt_test</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, using these binary columns, apply our optimised RBS Pipeline to the test set, using the <em>transform</em> method:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[176]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pipe_pred_test</span> <span class="o">=</span> <span class="n">rbso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_test</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_test</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="id8">
<h3>Outputs<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The <em>.predict()</em> method returns the prediction of the optimised pipeline by applying it to the given dataset.</p>
<p>A useful attribute created by running the <em>.predict()</em> method is:</p>
<ul class="simple">
<li><p>pipeline_opt_metric (float): The result of the <code class="docutils literal notranslate"><span class="pre">opt_func</span></code> function when the pipeline is applied.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_opt_metric</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9868995633187774
</pre></div></div>
</div>
<p>We can also use the <em>.calc_performance()</em> method to generate some performance metrics for the pipeline:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[178]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">calc_performance</span><span class="p">(</span>
    <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
    <span class="n">y_pred</span><span class="o">=</span><span class="n">pipe_pred_test</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_perf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Precision</th>
      <th>Recall</th>
      <th>PercDataFlagged</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.982609</td>
      <td>0.991228</td>
      <td>0.026244</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.999766</td>
      <td>0.999531</td>
      <td>0.973756</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[180]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">conf_matrix</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[180]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>113.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>4266.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[181]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">config</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[181]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{1: [&#39;RGDT_Rule_20211202_25&#39;,
   &#39;RGDT_Rule_20211202_24&#39;,
   &#39;RGDT_Rule193&#39;,
   &#39;RGDT_Rule241&#39;,
   &#39;RGDT_Rule_20211202_27&#39;]}]
</pre></div></div>
</div>
</section>
<section id="Compare-to-initial-RBS-pipeline-performance">
<h3>Compare to initial RBS pipeline performance<a class="headerlink" href="#Compare-to-initial-RBS-pipeline-performance" title="Permalink to this headline">¶</a></h3>
<p>If we assume that, for our initial RBS pipeline:</p>
<ul class="simple">
<li><p>Only the <strong>original, existing rules</strong> were used (since these are likely to be the rules that are currently productionised).</p></li>
<li><p>The RBS pipeline was set up in a similar way to our optimised RBS Pipeline (i.e. if any rules trigger, reject the transaction; else, approve the transaction).</p></li>
</ul>
<p>then we can calculate the performance of the initial RBS Pipeline and compare it to our optimised pipeline.</p>
<p>To set up the initial RBS Pipeline, we follow a similar process as before. First, we need the names of the <strong>original, existing rules</strong> that are used to reject transactions:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[182]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">existing_rule_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">existing_rules</span><span class="o">.</span><span class="n">rule_strings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>Then we can create our <em>config</em> using these rule names:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[183]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">existing_rule_names</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, we need to apply the original, existing rules to the test set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X_rules_existing_test</span> <span class="o">=</span> <span class="n">existing_rules</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then instantiate the <em>RBSPipeline</em> class using <em>config</em> we created above, keeping the other parameters the same:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[185]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbsp_initial</span> <span class="o">=</span> <span class="n">RBSPipeline</span><span class="p">(</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">final_decision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">f1</span><span class="o">.</span><span class="n">fit</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can apply the initial RBS pipeline to the test set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[186]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pipe_pred_initial_test</span> <span class="o">=</span> <span class="n">rbsp_initial</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">X_rules</span><span class="o">=</span><span class="n">X_rules_existing_test</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can also use the <em>.calc_performance()</em> method to generate some performance metrics for the pipeline:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbsp_initial</span><span class="o">.</span><span class="n">calc_performance</span><span class="p">(</span>
    <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
    <span class="n">y_pred</span><span class="o">=</span><span class="n">pipe_pred_initial_test</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Performance-comparison">
<h4>Performance comparison<a class="headerlink" href="#Performance-comparison" title="Permalink to this headline">¶</a></h4>
<p>Finally, we can compare the performance of the initial RBS Pipeline and the optimised RBS Pipeline:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[188]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># F1 Score</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The F1 score of the initial RBS Pipeline is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">rbsp_initial</span><span class="o">.</span><span class="n">pipeline_opt_metric</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The F1 score of the optimised RBS Pipeline is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_opt_metric</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% improvement in F1 score is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">rbso</span><span class="o">.</span><span class="n">pipeline_opt_metric</span><span class="o">-</span><span class="n">rbsp_initial</span><span class="o">.</span><span class="n">pipeline_opt_metric</span><span class="p">)</span><span class="o">/</span><span class="n">rbsp_initial</span><span class="o">.</span><span class="n">pipeline_opt_metric</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The F1 score of the initial RBS Pipeline is: 0.092
The F1 score of the optimised RBS Pipeline is: 0.987
% improvement in F1 score is: 969%
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[189]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conf_matrix_diff</span> <span class="o">=</span> <span class="n">rbso</span><span class="o">.</span><span class="n">conf_matrix</span> <span class="o">-</span> <span class="n">rbsp_initial</span><span class="o">.</span><span class="n">conf_matrix</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[190]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute change in true positives: </span><span class="si">{</span><span class="n">conf_matrix_diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute change in false positives: </span><span class="si">{</span><span class="n">conf_matrix_diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute change in true negatives: </span><span class="si">{</span><span class="n">conf_matrix_diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute change in false negatives: </span><span class="si">{</span><span class="n">conf_matrix_diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Absolute change in true positives: -1.0
Absolute change in false positives: -2239.0
Absolute change in true negatives: 2239.0
Absolute change in false negatives: 1.0
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
</section>
<section id="Convert-generated-rule-conditions-to-system-ready">
<h2>Convert generated rule conditions to system-ready<a class="headerlink" href="#Convert-generated-rule-conditions-to-system-ready" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our final rule set and our optimised RBS Pipeline, we can convert the conditions of the generated rules to work on raw, unprocessed data (which is usually the type of data seen in a production system) - this involves the following:</p>
<ul class="simple">
<li><p>Adding a null condition if the generated condition covered imputed null values.</p></li>
<li><p>Converting generated conditions with One Hot Encoded features into conditions that flag that specific category.</p></li>
</ul>
<p>For example:</p>
<ul class="simple">
<li><p>If a numeric rule condition initially had a threshold such that the imputed null values were included in the condition, the converted condition has an additional condition to check whether the feature is also null.</p>
<ul>
<li><p>E.g. If a rule initially had the logic <em>(X[‘num_items’]&lt;=1)</em> (which included the imputed value of 0), then the converted rule logic would be <em>((X[‘num_items’]&lt;=1)|(X[‘num_items’].isna()))</em>, with an additional condition to check for nulls.</p></li>
</ul>
</li>
<li><p>If a categorical rule condition checks whether the value is the imputed null category, the converted condition is such that it will explicitly check for null values.</p>
<ul>
<li><p>E.g. If a rule initially had the logic <em>(X[‘country_missing’]==True)</em>, then the converted rule logic would be <em>(X[‘country’].isna())</em>, such that it explicitly checks for null values.</p></li>
</ul>
</li>
<li><p>For categorical rule conditions, the converted condition is such that it will explicitly check for the category.</p>
<ul>
<li><p>E.g. If a rule initially had the logic <em>(X[‘country_US’]==False)</em>, then the converted rule logic woul dbe <em>(X[‘country’]!=‘US’)</em>, such that it explicitly checks whether the ‘country’ column is not equal to the ‘US’ category.</p></li>
</ul>
</li>
</ul>
<p>To do this, we can use the <em>ConvertProcessedConditionsToGeneral</em> class from the <em>convert_processed_conditions_to_general</em> module. Note that we only need to apply this process to the generated rules, since those are the only rules which reference the processed data.</p>
<p>Before we can use this class, we need to provide the following:</p>
<ul class="simple">
<li><p>A dictionary of the value used to impute nulls for each feature in the original, unprocessed dataset.</p></li>
<li><p>A dictionary of the category linked to each One Hot Encoded column.</p></li>
</ul>
<p>To get these dictionaries, we can use the <em>ReturnMappings</em> class from the <em>convert_processed_conditions_to_general</em> module:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[191]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rm</span> <span class="o">=</span> <span class="n">ReturnMappings</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[192]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">imputed_values_mapping</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">return_imputed_values_mapping</span><span class="p">(</span>
    <span class="p">[</span><span class="n">num_cols</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">cat_cols</span><span class="p">,</span> <span class="s1">&#39;missing&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="n">bool_cols</span><span class="p">,</span> <span class="s1">&#39;missing&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[193]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ohe_categories_mapping</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">return_ohe_categories_mapping</span><span class="p">(</span>
    <span class="n">pre_ohe_cols</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">post_ohe_cols</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">pre_ohe_dtypes</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">dtypes</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now that we have our mapping dictionaries for imputed values and one hot encoded values, we can convert the logic of our generated rules to make them production-ready:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[194]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conv_gen_rules</span> <span class="o">=</span> <span class="n">ConvertProcessedConditionsToGeneral</span><span class="p">(</span>
    <span class="n">imputed_values</span><span class="o">=</span><span class="n">imputed_values_mapping</span><span class="p">,</span>
    <span class="n">ohe_categories</span><span class="o">=</span><span class="n">ohe_categories_mapping</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[195]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conv_gen_rule_strings</span> <span class="o">=</span> <span class="n">conv_gen_rules</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="n">rule_strings</span><span class="o">=</span><span class="n">gs_gen</span><span class="o">.</span><span class="n">rule_strings</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="id9">
<h3>Outputs<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>The <em>.convert()</em> method returns a dictionary containing the set of rules which account for imputed/OHE variables, defined using the standard Iguanas string format (values) and their names (keys).</p>
<p>A useful attribute created by running the <em>.convert()</em> method is:</p>
<ul class="simple">
<li><p>rules: Class containing the rules stored in the standard Iguanas string format. Methods from this class can be used to convert the rules into the standard Iguanas dictionary or lambda expression representations. See the <em>rules</em> module for more information.</p></li>
</ul>
<hr class="docutils" />
</section>
</section>
<section id="Our-final-rule-set-and-RBS-Pipeline">
<h2>Our final rule set and RBS Pipeline<a class="headerlink" href="#Our-final-rule-set-and-RBS-Pipeline" title="Permalink to this headline">¶</a></h2>
<p>We can now (finally!) create the rule set that we’ll use in our optimised RBS pipeline. All we need to do is add our generated rules (that were reformatted for raw data) to our optimised rules:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[196]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbs_rule_strings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">rbs_rule_strings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conv_gen_rule_strings</span><span class="p">)</span>
<span class="n">rbs_rule_strings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gs_opt</span><span class="o">.</span><span class="n">rule_strings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we can create an instance of the <em>Rules</em> class using these rules (we can use this class to change between representations of the rules, if required):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[197]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbs_rules</span> <span class="o">=</span> <span class="n">Rules</span><span class="p">(</span><span class="n">rule_strings</span><span class="o">=</span><span class="n">rbs_rule_strings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Our final rules (in the standard Iguanas string format):</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[198]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbs_rules</span><span class="o">.</span><span class="n">rule_strings</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[198]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;RGDT_Rule_20211202_27&#39;: &#34;(X[&#39;account_number_num_fraud_transactions_per_account_number_7day&#39;]&gt;=1)&amp;(X[&#39;account_number_num_fraud_transactions_per_account_number_90day&#39;]&gt;=1)&#34;,
 &#39;RGDT_Rule_20211202_24&#39;: &#34;(X[&#39;account_number_num_fraud_transactions_per_account_number_30day&#39;]&gt;=1)&amp;((X[&#39;is_existing_user&#39;]&lt;=0)|(X[&#39;is_existing_user&#39;].isna()))&#34;,
 &#39;RGDT_Rule_20211202_25&#39;: &#34;(X[&#39;account_number_num_fraud_transactions_per_account_number_30day&#39;]&gt;=1)&amp;(X[&#39;order_total&#39;]&gt;916.82501)&#34;,
 &#39;RGDT_Rule193&#39;: &#34;(X[&#39;account_number_num_distinct_transaction_per_account_number_30day&#39;]&gt;=2.0)&amp;(X[&#39;account_number_num_fraud_transactions_per_account_number_lifetime&#39;]&gt;=2.0)&#34;,
 &#39;RGDT_Rule241&#39;: &#34;(X[&#39;account_number_avg_order_total_per_account_number_90day&#39;]&gt;153.949)&amp;(X[&#39;account_number_num_fraud_transactions_per_account_number_1day&#39;]&gt;=1.0)&amp;((X[&#39;account_number_sum_order_total_per_account_number_1day&#39;]&lt;=623.10999)|(X[&#39;account_number_sum_order_total_per_account_number_1day&#39;].isna()))&amp;(X[&#39;account_number_sum_order_total_per_account_number_30day&#39;]&gt;329.12)&#34;}
</pre></div></div>
</div>
<p><strong>Our optimised RBS Pipeline configuration:</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[199]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rbso</span><span class="o">.</span><span class="n">config</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[199]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{1: [&#39;RGDT_Rule_20211202_25&#39;,
   &#39;RGDT_Rule_20211202_24&#39;,
   &#39;RGDT_Rule193&#39;,
   &#39;RGDT_Rule241&#39;,
   &#39;RGDT_Rule_20211202_27&#39;]}]
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, James Laidler.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.1.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>