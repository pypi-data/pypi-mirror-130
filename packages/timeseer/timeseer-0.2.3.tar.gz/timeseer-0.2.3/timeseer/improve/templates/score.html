{% extends 'timeseer.html' %}
{% from 'macros.html' import bootstrap_icon, visualize_score, visualize_series_name, visualize_split_kpi_score %}

{% block scripts %}
<script src="{{ url_for('static', filename='dist/charts.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
.ts-score-card {
    width: 25rem;
}
.ts-score-column {
    width: 5.5rem;
}

#timeseries_source_score {
    max-width: 30rem;
    max-height: 20rem;
}
</style>
{% endblock %}

{% block main %}
<div class="ts-section py-3 my-3">
    <div class="row align-items-center gx-2">
        <div class="col-md">
            <h2 class="h4">{{ source_name }}</h2>
        </div>
        <div class="col-md-auto">
            <a  href="{{ url_for('.list_reports', sourcename=source_name) }}"
                class="btn btn-primary">
                History
            </a>
        </div>
    </div>
</div>

<div class="ts-section pb-4 my-3">
    <div class="row">
        {% for score in quadrant_scores|sort(attribute='name.value') %}
        <div class="col-md-3 col-lg-2">
            {{ visualize_split_kpi_score(score.score) }}
            <div class="row"><small class="text-muted">{{ score.name.value|capitalize }}</small></div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="pt-3 my-3">
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="row align-items-center justify-content-between">
                <h3 class="col-sm-6 mb-0 h5">Quality KPI scores</h3>
                {% if kpi_scores|count > 0 and sources|count > 1%}
                <div class="dropdown col-sm-auto">
                    <button type="button"
                            class="btn btn-sm btn-secondary dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false">
                        Compare to
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item {% if compare_to == 'Median' %}active{% endif %}"
                           {% if compare_to != 'Median' %}
                           href="{{ url_for ('.score_source', sourcename=source_name, compareTo='Median') }}"
                           {% endif %}>
                           Median
                        </a>
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">Sources</h6>
                        {% for source in sources if source.name != source_name %}
                        <a class="dropdown-item {% if compare_to == source.name %}active{% endif %}"
                           {% if compare_to != source.name %}
                           href="{{ url_for('.score_source', sourcename=source_name, compareTo=source.name) }}"
                           {% endif %}>
                            {{ source.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% if kpi_scores|count > 0 %}
        <div class="row gx-0">
            <div class="col border-end d-flex justify-content-center">
                <div id='timeseries_source_score'></div>
            </div>
            <div class="col">
                <table class="ts-table table table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">KPI</th>
                            <th scope="col">{{ compare_to }}</th>
                            <th scope="col">{{ source_name }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kpi in kpis %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-decoration-none text-dark" href="{{ url_for('.kpi_report', kpi=kpi.name, sourcename=source_name) }}">
                                    {{ kpi.name }}
                                </a>
                            </th>
                            {% if kpi.name in comparison_kpi_scores %}
                            {{ visualize_score(comparison_kpi_scores[kpi.name]) }}
                            {% else %}
                            <td>-</td>
                            {% endif %}
                            {% if kpi.name in kpi_scores %}
                            {{ visualize_score(kpi_scores[kpi.name]) }}
                            {% else %}
                            <td>-</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="text-muted text-center p-1">
            <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to calculate scores.
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <div class="d-flex flex-wrap justify-content-between">
        <div class="d-flex flex-wrap flex-grow-1 justify-content-center">
            <div class="ts-score-card card shadow-sm mx-1 mb-3">
                <h3 class="card-header h5">Metadata bugs scores</h3>
                {% if metadata_bugs_scores|count > 0 %}
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Bug</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in metadata_bugs_scores %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi='Metadata', score=result.metadata.name) }}">
                                    {{ result.metadata.name|capitalize }}
                                </a>
                                {% if result.metadata.short_help_text %}
                                <span data-bs-toggle="popover"
                                    data-bs-placement="right"
                                    data-bs-trigger="hover"
                                    data-bs-content="{{ result.metadata.short_help_text }}">
                                    {{ bootstrap_icon('question-circle') }}
                                </span>
                                {% endif %}
                            </th>
                            {{ visualize_score(result.score) }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-muted text-center p-1">
                    <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to detect issues.
                </div>
                {% endif %}
            </div>

            <div class="ts-score-card card shadow-sm mx-1 mb-3">
                <h3 class="card-header h5">Metadata smells scores</h3>
                {% if metadata_smells_scores|count > 0 %}
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Smell</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in metadata_smells_scores %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi='Metadata', score=result.metadata.name) }}">
                                    {{ result.metadata.name }}
                                </a>
                                {% if result.metadata.short_help_text %}
                                <span data-bs-toggle="popover"
                                    data-bs-placement="right"
                                    data-bs-trigger="hover"
                                    data-bs-content="{{ result.metadata.short_help_text }}">
                                    {{ bootstrap_icon('question-circle') }}
                                </span>
                                {% endif %}
                            </th>
                            {{ visualize_score(result.score) }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-muted text-center p-1">
                    <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to detect issues.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex flex-wrap flex-grow-1 justify-content-center">
            <div class="ts-score-card card shadow-sm mx-1 mb-3">
                <h3 class="card-header h5">Series bugs scores</h3>
                {% if series_bugs_scores|count > 0 %}
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Bug</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in series_bugs_scores[0:10] %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi=result.metadata.kpi, score=result.metadata.name) }}">
                                    {{ result.metadata.name }}
                                </a>
                                {% if result.metadata.short_help_text %}
                                <span data-bs-toggle="popover"
                                    data-bs-placement="right"
                                    data-bs-trigger="hover"
                                    data-bs-content="{{ result.metadata.short_help_text }}">
                                    {{ bootstrap_icon('question-circle') }}
                                </span>
                                {% endif %}
                            </th>
                            {{ visualize_score(result.score) }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-muted text-center p-1">
                    <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to rank checks.
                </div>
                {% endif %}
            </div>

            <div class="ts-score-card card shadow-sm mx-1 mb-3">
                <h3 class="card-header h5">Series smells scores</h3>
                {% if series_smells_scores|count > 0 %}
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Smell</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in series_smells_scores[0:10] %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi=result.metadata.kpi, score=result.metadata.name) }}">
                                    {{ result.metadata.name }}
                                </a>
                                {% if result.metadata.short_help_text %}
                                <span data-bs-toggle="popover"
                                    data-bs-placement="right"
                                    data-bs-trigger="hover"
                                    data-bs-content="{{ result.metadata.short_help_text }}">
                                    {{ bootstrap_icon('question-circle') }}
                                </span>
                                {% endif %}
                            </th>
                            {{ visualize_score(result.score) }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-muted text-center p-1">
                    <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to rank smells.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex flex-wrap flex-grow-1 justify-content-center">
            <div class="ts-score-card card shadow-sm mx-1 mb-3">
                <div class="card-header">
                    <div class="row align-items-center justify-content-between">
                        <h3 class="col-sm-8 mb-0 h5">Worst scoring series</h3>
                        <form class="col-sm-auto" action="{{ url_for('.series_score_report') }}">
                            <input type="hidden" name="sourcename" value="{{ source_name }}">
                            <button type="submit" class="btn btn-sm btn-secondary">Display all</button>
                        </form>
                    </div>
                </div>

                {% if worst_series|count > 0 %}
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Series name</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for series, score in worst_series.items() %}
                        <tr class="border-bottom">
                            <th scope="row">
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('prepare.tags', seriesid=series.series_id) }}"
                                class="text-break">
                                    {{ visualize_series_name(series.name) }}
                                </a>
                            </th>
                            {{ visualize_score(score) }}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-muted text-center p-1">
                    <a href="{{ url_for('sources.display_configuration', sourcename=source_name) }}">Analyze time series</a> to find units.
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% if kpi_scores|count > 0 %}
<script>
{% include 'scripts/kpi-scores.js' %}
</script>
{% endif %}

{% endblock %}
