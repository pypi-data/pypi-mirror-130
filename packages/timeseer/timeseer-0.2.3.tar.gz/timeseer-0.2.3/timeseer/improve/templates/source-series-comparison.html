{% extends 'timeseer.html' %}

{% from 'macros.html' import bootstrap_icon, info_popover, menu_back, visualize_check_result, visualize_series_name %}

{% block styles %}
<style>
    .comparison-table {
        table-layout: fixed;
    }
{% if many_series|count > 4 %}
    .comparison-table .series-name {
        height: 200px;
        white-space: nowrap;
    }
    .comparison-table .series-name > div {
        transform: rotate(315deg);
        width: 1px;
    }
{% endif %}
    .comparison-table .kpi-name {
        width: 20%;
    }
</style>
{% endblock %}

{% block menu %}
{{ menu_back(url_for('.series_score_report', sourcename=source_name)) }}
{% endblock %}

{% block main %}
<div class="ts-section py-3 my-3">
    <div class="row align-items-center gx-2">
        <div class="col-md">
            <h2 class="h4">Time series score comparison</h2>
            <p class="h6 text-break">{{ source_name }}</p>
        </div>
        <div class="col-md-auto">
            <a class="btn btn-primary"
                data-bs-toggle="offcanvas"
                href="#series-selection"
                aria-controls="series-selection"
                aria-expanded="false">
             Edit series
         </a>
        </div>
    </div>
</div>

<div class="offcanvas {% if many_series|count < 2 %}show{% endif %} offcanvas-end" tabindex="-1" id="series-selection">
    <div class="offcanvas-header">
        <h3 class="offcanvas-title h5">Select time series</h3>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="row align-items-center gx-2">
            {% if many_series|count > 0 %}
            <div class="col-md-auto">
                <div class="btn-group ts-dropdown-select-button">
                    <a class="btn border border-secondary dropdown-toggle"
                    href="#"
                    role="button"
                    id="selectionDropdown"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false">
                    </a>
                    <div class="dropdown-menu" aria-labelledby="selectionDropdown">
                        <button type="submit"
                                class="dropdown-item ts-dropdown-action"
                                form="removeseries"
                                >
                                Remove selected series from comparison
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if many_series|count > 0 %}
        <form id="removeseries" class="mt-3">
            {% if source_name %}
            <input type="hidden" name="sourcename" value="{{ source_name }}">
            {% endif %}
            {% for series in many_series %}
            <input type="hidden" name="series" value="{{ series.series_id }}">
            {% endfor %}

            <table class="ts-table ts-table-checkbox table table-borderless" data-ts-target="selectionDropdown">
                <thead class="thead-secondary">
                    <tr class="border-top border-bottom">
                        <th scope="col" class="checkbox">
                            <input class="form-check-input" type="checkbox">
                        </th>
                        <th scope="col">Series name</th>
                    </tr>
                </thead>
                <tbody>
                    {% for series in many_series %}
                    <tr class="border-bottom">
                        <td>
                            <input class="form-check-input" type="checkbox" name="removeseries" value="{{ series.series_id }}">
                        </td>
                        <td>
                            <a class="ts-table-link text-dark text-decoration-none"
                                href="{{ url_for('prepare.tags', seriesid=series.series_id) }}"
                                data-ts-series-source="{{ series.source }}"
                                data-ts-series-name="{{ series.name }}">
                                {{ series.name }}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        {% else %}
        <p class="alert alert-info">No series in comparison.</p>
        {% endif %}

        {% if many_series|count < 8 %}
        <form>
            <input type="hidden" name="sourcename" value="{{ source_name }}">
            {% for series in many_series %}
            <input type="hidden" name="series" value="{{ series.series_id }}">
            {% endfor %}
            <div class="mb-3">
                <label for="seriesInput" class="form-label">Add one time series to the comparison</label>
                <input type="text"
                    class="form-control"
                    id="seriesInput"
                    name="seriesname"
                    placeholder="Type to search time series"
                    autocomplete="off"
                    required>
            </div>
            <div class="mb-3">
                <button type="submit" class="btn btn-primary">Add series</button>
            </div>
        </form>
        {% else %}
        <p class="alert alert-info">
            Can only compare up to 8 series.
        </p>
        {% endif %}
    </div>
</div>

<div class="pt-3 my-3">
    {% if many_series|count < 2 %}
    <div class="alert alert-info">
        Add at least two time series to compare.
    </div>
    {% else %}

    {% if all_results|count > 0 %}
    {% for kpi in kpis %}
    <table class="ts-table table table-borderless comparison-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col" class="kpi-name">{{ kpi.name }}</th>
                {% for series in many_series|sort(attribute="source,name") %}
                <th scope="col" class="series-name">
                    <div>{{ visualize_series_name(series.name) }}</div>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for check_name in all_results[kpi.name.lower()]|sort %}
            <tr class="border-bottom">
                <th scope="row" class="fw-normal">
                    {{ check_name|capitalize }}
                    {% if check_name in check_metadata %}
                    {{ info_popover(check_metadata[check_name].short_help_text) }}
                    {% endif %}
                </th>
                {% for series in many_series|sort(attribute="source,name") %}
                {% if series in all_results[kpi.name.lower()][check_name] %}
                {{ visualize_check_result(all_results[kpi.name.lower()][check_name][series]) }}
                {% else %}
                <td>-</td>
                {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
        Analyze time series to compare results.
    </div>
    {% endif %}
    {% endif %}
</div>

<script>
    var existingSeries = [];
    for (const series of document.querySelectorAll('[data-ts-series-name]')) {
        existingSeries.push({
            source: series.getAttribute('data-ts-series-source'),
            name: series.getAttribute('data-ts-series-name'),
        });
    }

    var sourceName = "{{ source_name }}";
    $('#seriesInput').autoComplete({
        bootstrapVersion: '4',
        noResultsText: 'No matching series known.',
        resolver: 'custom',
        events: {
            search: function (pattern, callback) {
                var params = {
                    'source': sourceName,
                    'pattern': pattern,
                };
                $.ajax('{{ url_for('api.search_series_names') }}', {data: params})
                .done(function(data) {
                    var seriesInSource = existingSeries
                        .filter(function (series) {return series.source === sourceName;})
                        .map(function (series) {return series.name;});
                    callback(data.filter(function (seriesName) {return !seriesInSource.includes(seriesName);}));
                });
            },
        },
    });
</script>
{% endblock %}
