{% extends 'timeseer.html' %}

{% from 'macros.html' import bootstrap_icon, menu, visualize_score %}
{% from 'improve.html' import improve_menu with context %}

{% block styles %}
<style>
    .score-table {
        table-layout: fixed;
    }
</style>
{% endblock %}

{% block menu %}
{{ improve_menu(kpi.name) }}
{% endblock %}

{% block main %}
<div class="ts-section py-3 my-3">
    <div class="row align-items-center gx-2">
        <div class="col-md">
            <h2 class="h4">{{ kpi.name }}</h2>
            <p class="h6 text-break">{{ source_name }}</p>
        </div>
        <div class="col-md-auto">
            <a  href="{{ url_for('.kpi_evolution', sourcename=source_name, kpi=kpi.name) }}"
                class="btn btn-primary">
                History
            </a>
        </div>
    </div>
</div>

<div class="pt-3 my-3">
    <p>
        {{ kpi.short_help_text }}
        <a data-bs-toggle="offcanvas"
           href="#kpi-help-text"
           aria-controls="kpi-help-text"
           aria-expanded="false">
            {{ bootstrap_icon('question-circle') }}
        </a>
    </p>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="kpi-help-text">
        <div class="offcanvas-header">
            <h3 class="offcanvas-title h5">{{ kpi.name }}</h3>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
        {{ kpi.html_help_text|safe }}
        </div>
    </div>
</div>

<div class="my-3">
    {% if bugs_scores|count > 0 %}
    <table class="ts-table table table-borderless score-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col">Bug</th>
                <th scope="col">Score (higher is better)</th>
            </tr>
        </thead>
        <tbody>
            {% for result in bugs_scores %}
            <tr class="border-bottom">
                <td>
                    <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi=kpi.name, score=result.metadata.name) }}">
                        {{ result.metadata.name|capitalize }}
                    </a>
                    {% if result.metadata.short_help_text %}
                    <span data-bs-toggle="popover"
                          data-bs-placement="right"
                          data-bs-trigger="hover"
                          data-bs-content="{{ result.metadata.short_help_text }}">
                        <svg class="bi" width="16" height="16" fill="currentColor">
                            <use xlink:href="/static/dist/bootstrap-icons.svg#question-circle"/>
                        </svg>
                    </span>
                    {% endif %}
                </td>
                {{ visualize_score(result.score) }}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if smells_scores|count > 0 %}
    <table class="ts-table table table-borderless score-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col">Smell</th>
                <th scope="col">Score (higher is better)</th>
            </tr>
        </thead>
        <tbody>
            {% for result in smells_scores %}
            <tr class="border-bottom">
                <td>
                    <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_report', sourcename=source_name, kpi=kpi.name, score=result.metadata.name) }}">
                        {{ result.metadata.name }}
                    </a>
                    <span data-bs-toggle="popover"
                          data-bs-placement="right"
                          data-bs-trigger="hover"
                          data-bs-content="{{ result.metadata.short_help_text }}">
                        <svg class="bi" width="16" height="16" fill="currentColor">
                            <use xlink:href="/static/dist/bootstrap-icons.svg#question-circle"/>
                        </svg>
                    </span>
                </td>
                {{ visualize_score(result.score) }}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}
