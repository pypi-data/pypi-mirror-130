// Generated by CoffeeScript 1.8.0
(function() {
  var placeholder_image;

  this.image_inited_objs = [];

  placeholder_image = '/drop_image_here.png';

  this.init_image_field = function(dom) {
    var filepath, image_block_dom, image_extensions, img_dom, img_dom_id, percent_bar_dom, percent_dom, picker_dom_id, post_url, uploader;
    img_dom = $(dom);
    if (img_dom.parents('.template').length) {
      return false;
    }
    if (img_dom.hasClass('inited')) {
      return false;
    }
    image_block_dom = img_dom.parents('.image_block');
    percent_bar_dom = image_block_dom.find('.percent_bar');
    percent_dom = image_block_dom.find('.percent');
    img_dom.addClass('inited');
    post_url = $(dom).attr("data-post-url") || '/__file_manager_api';
    filepath = $(dom).attr("data-filepath") || '';
    image_extensions = 'gif,jpg,jpeg,bmp,png';
    if (filepath.indexOf('.ico') !== -1) {
      image_extensions = 'png,ico';
    }
    picker_dom_id = 'img_picker_' + parseInt(Math.random() * 1000000000000000);
    img_dom.parent().find('.upload_image_action').attr('id', picker_dom_id);
    img_dom_id = 'img_dropper_' + parseInt(Math.random() * 1000000000000000);
    img_dom.attr('id', img_dom_id);
    uploader = WebUploader.create({
      dnd: '#' + img_dom_id,
      server: post_url,
      pick: '#' + picker_dom_id,
      resize: false,
      chunked: false,
      compress: false,
      preserveHeaders: true,
      accept: {
        title: 'Images',
        extensions: image_extensions,
        mimeTypes: 'image/*'
      },
      thumb: {
        quality: 90,
        allowMagnify: true,
        crop: true,
        type: 'image/jpeg'
      }
    });
    uploader.on('fileQueued', function(file) {
      uploader.makeThumb(file, function(error, rect) {
        if (!error) {
          return img_dom.attr('src', rect);
        }
      }, img_dom.width() * 2, img_dom.height() * 2);
      filepath = $(dom).attr("data-filepath");
      if (filepath && filepath.indexOf('/fb_static/') === 0) {
        filepath = '';
      }
      if (filepath === placeholder_image) {
        filepath = '';
      } else if (filepath && filepath.indexOf('://') !== -1) {
        filepath = '';
      }
      if (!filepath) {
        filepath = "/_images/r" + parseInt(Math.random() * 1000000000000000) + '.' + file.ext;
        img_dom.attr('data-filepath', filepath);
      }
      uploader.options.server = post_url + '?path=' + filepath;
      return uploader.upload();
    });
    uploader.on('uploadProgress', function(file, percentage) {
      var percent;
      percent = percentage * 100;
      percent_bar_dom.css('display', 'block');
      return percent_dom.css('width', percent + '%');
    });
    uploader.on('uploadSuccess', function(file, response) {
      return percent_bar_dom.css('display', 'none');
    });
    return true;
  };

  this.do_clear_image_filepath = function(action_dom) {
    var image_field_dom, image_filepath, img_dom;
    image_field_dom = $(action_dom).parents('.image_block');
    img_dom = image_field_dom.find('img');
    image_filepath = img_dom.attr('data-filepath');
    img_dom.attr('src', placeholder_image);
    if (img_dom.attr('data-clear-is-delete') === 'yes' && image_filepath) {
      return $.ajax({
        url: '/__file_manager_api',
        method: 'post',
        data: {
          is_dir: false,
          path: image_filepath,
          is_deleted: true
        }
      });
    } else {
      return img_dom.attr('data-filepath', '');
    }
  };

  this.clear_image_filepath = function(action_dom) {
    var swal_configs;
    swal_configs = {
      title: "clear it as an empty image?",
      text: "",
      type: "info",
      animation: false,
      showCancelButton: true,
      closeOnConfirm: true,
      showLoaderOnConfirm: false
    };
    if (typeof swal !== "undefined" && swal !== null) {
      return swal(swal_configs, function(do_it) {
        if (do_it) {
          return do_clear_image_filepath(action_dom);
        }
      });
    } else {
      return do_clear_image_filepath(action_dom);
    }
  };

  this.init_image_fields = function() {
    var form_image_dom, form_image_doms, _form_image_doms, _i, _len;
    _form_image_doms = $('.form_image_dom:not(.inited)');
    form_image_doms = [];
    for (_i = 0, _len = _form_image_doms.length; _i < _len; _i++) {
      form_image_dom = _form_image_doms[_i];
      if (!$(form_image_dom).parents('.template').length) {
        form_image_doms.push(form_image_dom);
      }
    }
    if (!form_image_doms.length) {
      return false;
    }
    return init_image_field(form_image_doms[0]);
  };

  $(document).ready(function() {
    init_image_fields();
    return $('body').on('DOMNodeInserted', 'div', function() {
      var div_dom, image_block_dom;
      div_dom = $(this);
      image_block_dom = div_dom.parents('.image_block');
      if (image_block_dom.length && div_dom.find('input.webuploader-element-invisible').length && !image_block_dom.hasClass('finished')) {
        image_block_dom.addClass('finished');
        return init_image_fields();
      }
    });
  });

}).call(this);
